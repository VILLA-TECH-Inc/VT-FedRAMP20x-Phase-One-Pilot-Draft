resource "local_file" "fedramp_compliance_template" {
  filename = "${path.module}/templates/fedramp-low-compliance-template.json"
  content = jsonencode({
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "https://compliance.structura.io/schemas/fedramp-low-v1.0.json",
    "title": "FedRAMP Low Compliance Report Template",
    "description": "Machine-readable template for FedRAMP Low compliance assessments with detailed scoring methodology",
    "type": "object",
    "required": [
      "report_metadata",
      "scoring_methodology",
      "executive_summary", 
      "fedramp_low_ksi_assessment",
      "security_controls_matrix",
      "infrastructure_assessment",
      "compliance_gaps",
      "recommendations",
      "next_assessment",
      "certification_readiness"
    ],
    "properties": {
      "report_metadata": {
        "type": "object",
        "required": ["report_id", "project_id", "report_date", "compliance_framework"],
        "properties": {
          "report_id": {
            "type": "string",
            "pattern": "^fedramp-low-compliance-[a-zA-Z0-9-]+$",
            "description": "Unique identifier for the compliance report"
          },
          "project_id": {
            "type": "string",
            "description": "STRUCTURA.IO project identifier"
          },
          "report_date": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp of report generation"
          },
          "compliance_framework": {
            "type": "string",
            "enum": ["FedRAMP Low", "FedRAMP Moderate", "FedRAMP High"],
            "description": "Target compliance framework"
          },
          "architecture_type": {
            "type": "string",
            "enum": ["Cloud Native", "Hybrid", "On-Premises", "Multi-Cloud"],
            "description": "System architecture classification"
          },
          "cloud_provider": {
            "type": "string",
            "enum": ["Microsoft Azure Government", "AWS GovCloud", "Google Cloud", "Multi-Cloud"],
            "description": "Primary cloud service provider"
          },
          "assessment_version": {
            "type": "string",
            "pattern": "^\\d+\\.\\d+$",
            "description": "Version of the assessment methodology"
          },
          "assessor": {
            "type": "string",
            "description": "Entity or system performing the assessment"
          }
        }
      },
      "scoring_methodology": {
        "type": "object",
        "required": ["calculation_method", "status_assignment_rules", "weighting_factors"],
        "properties": {
          "calculation_method": {
            "type": "object",
            "required": ["overall_score_formula", "ksi_score_calculation"],
            "properties": {
              "overall_score_formula": {
                "type": "string",
                "default": "Weighted average of all KSI scores: (Σ(KSI_score × KSI_weight)) / Σ(KSI_weight)",
                "description": "Mathematical formula used to calculate overall compliance score"
              },
              "ksi_score_calculation": {
                "type": "string",
                "default": "Based on control implementation percentage and finding severity deductions",
                "description": "Method for calculating individual KSI scores"
              },
              "score_ranges": {
                "type": "object",
                "properties": {
                  "fully_implemented": {
                    "type": "object",
                    "properties": {
                      "min_score": { "type": "integer", "default": 90 },
                      "max_score": { "type": "integer", "default": 100 },
                      "description": { "type": "string", "default": "90-100% implementation with no critical findings" }
                    }
                  },
                  "partially_implemented": {
                    "type": "object",
                    "properties": {
                      "min_score": { "type": "integer", "default": 50 },
                      "max_score": { "type": "integer", "default": 89 },
                      "description": { "type": "string", "default": "50-89% implementation or critical findings present" }
                    }
                  },
                  "not_implemented": {
                    "type": "object",
                    "properties": {
                      "min_score": { "type": "integer", "default": 0 },
                      "max_score": { "type": "integer", "default": 49 },
                      "description": { "type": "string", "default": "0-49% implementation or fundamental control failures" }
                    }
                  },
                  "not_applicable": {
                    "type": "object",
                    "properties": {
                      "score": { "type": "string", "default": "N/A" },
                      "description": { "type": "string", "default": "Control not applicable to system architecture or business requirements" }
                    }
                  }
                }
              }
            }
          },
          "status_assignment_rules": {
            "type": "object",
            "required": ["fully_implemented", "partially_implemented", "not_implemented", "not_applicable"],
            "properties": {
              "fully_implemented": {
                "type": "object",
                "properties": {
                  "criteria": {
                    "type": "array",
                    "items": { "type": "string" },
                    "default": [
                      "All required controls are implemented and operational",
                      "Compliance score >= 90%",
                      "No critical or high severity findings",
                      "All evidence artifacts are present and current",
                      "Controls are tested and validated within last 12 months"
                    ]
                  },
                  "evidence_requirements": {
                    "type": "array",
                    "items": { "type": "string" },
                    "default": [
                      "Technical configuration evidence",
                      "Policy and procedure documentation",
                      "Testing and validation results",
                      "Monitoring and logging evidence"
                    ]
                  }
                }
              },
              "partially_implemented": {
                "type": "object",
                "properties": {
                  "criteria": {
                    "type": "array",
                    "items": { "type": "string" },
                    "default": [
                      "Some required controls are implemented but gaps exist",
                      "Compliance score between 50-89%",
                      "Critical findings present but remediation plan exists",
                      "Some evidence artifacts missing or outdated",
                      "Controls partially tested or validation incomplete"
                    ]
                  },
                  "common_scenarios": {
                    "type": "array",
                    "items": { "type": "string" },
                    "default": [
                      "Technical controls implemented but documentation incomplete",
                      "Policies exist but not fully operationalized",
                      "Controls implemented but not regularly tested",
                      "Compensating controls in place for missing primary controls"
                    ]
                  }
                }
              },
              "not_implemented": {
                "type": "object",
                "properties": {
                  "criteria": {
                    "type": "array",
                    "items": { "type": "string" },
                    "default": [
                      "Required controls are not implemented or non-functional",
                      "Compliance score < 50%",
                      "Critical findings with no remediation plan",
                      "Missing essential evidence artifacts",
                      "No testing or validation performed"
                    ]
                  },
                  "risk_implications": {
                    "type": "array",
                    "items": { "type": "string" },
                    "default": [
                      "High risk of security incidents",
                      "Non-compliance with regulatory requirements",
                      "Potential for data breaches or system compromise",
                      "ATO approval unlikely without significant remediation"
                    ]
                  }
                }
              },
              "not_applicable": {
                "type": "object",
                "properties": {
                  "criteria": {
                    "type": "array",
                    "items": { "type": "string" },
                    "default": [
                      "Control requirements do not apply to system architecture",
                      "Business requirements exclude control applicability",
                      "Alternative controls provide equivalent protection",
                      "System design inherently addresses control objectives"
                    ]
                  },
                  "documentation_requirements": {
                    "type": "array",
                    "items": { "type": "string" },
                    "default": [
                      "Formal determination of non-applicability",
                      "Technical justification for exclusion",
                      "Alternative control mapping if applicable",
                      "Approval from authorizing official"
                    ]
                  }
                }
              }
            }
          },
          "weighting_factors": {
            "type": "object",
            "properties": {
              "ksi_weights": {
                "type": "object",
                "properties": {
                  "KSI-CNA": { "type": "number", "default": 1.2, "description": "Cloud Native Architecture - Higher weight due to foundational importance" },
                  "KSI-SVC": { "type": "number", "default": 1.0, "description": "Service Management - Standard weight" },
                  "KSI-IAM": { "type": "number", "default": 1.3, "description": "Identity and Access Management - Critical security control" },
                  "KSI-MLA": { "type": "number", "default": 1.1, "description": "Monitoring, Logging, and Auditing - Important for compliance" },
                  "KSI-CMT": { "type": "number", "default": 1.0, "description": "Configuration Management - Standard weight" },
                  "KSI-PIY": { "type": "number", "default": 1.2, "description": "Privacy - High regulatory importance" },
                  "KSI-TPR": { "type": "number", "default": 1.1, "description": "Third Party Risk - Supply chain security" },
                  "KSI-CED": { "type": "number", "default": 1.3, "description": "Cryptography and Encryption - Critical for data protection" },
                  "KSI-RPL": { "type": "number", "default": 1.0, "description": "Response and Recovery - Standard weight" },
                  "KSI-INR": { "type": "number", "default": 1.1, "description": "Infrastructure Resilience - Important for availability" }
                }
              },
              "finding_severity_deductions": {
                "type": "object",
                "properties": {
                  "CRITICAL": { "type": "integer", "default": -25, "description": "Points deducted per critical finding" },
                  "HIGH": { "type": "integer", "default": -15, "description": "Points deducted per high finding" },
                  "MEDIUM": { "type": "integer", "default": -8, "description": "Points deducted per medium finding" },
                  "LOW": { "type": "integer", "default": -3, "description": "Points deducted per low finding" },
                  "INFORMATIONAL": { "type": "integer", "default": 0, "description": "No point deduction for informational findings" }
                }
              }
            }
          },
          "compliance_level_thresholds": {
            "type": "object",
            "properties": {
              "FULLY_COMPLIANT": {
                "type": "object",
                "properties": {
                  "min_score": { "type": "integer", "default": 95 },
                  "additional_requirements": {
                    "type": "array",
                    "items": { "type": "string" },
                    "default": ["No critical findings", "All KSIs fully implemented", "Complete documentation"]
                  }
                }
              },
              "SUBSTANTIALLY_COMPLIANT": {
                "type": "object",
                "properties": {
                  "min_score": { "type": "integer", "default": 85 },
                  "max_score": { "type": "integer", "default": 94 },
                  "additional_requirements": {
                    "type": "array",
                    "items": { "type": "string" },
                    "default": ["No more than 2 critical findings", "Remediation plan for all findings"]
                  }
                }
              },
              "PARTIALLY_COMPLIANT": {
                "type": "object",
                "properties": {
                  "min_score": { "type": "integer", "default": 70 },
                  "max_score": { "type": "integer", "default": 84 },
                  "additional_requirements": {
                    "type": "array",
                    "items": { "type": "string" },
                    "default": ["Significant remediation required", "Multiple KSIs partially implemented"]
                  }
                }
              },
              "NON_COMPLIANT": {
                "type": "object",
                "properties": {
                  "max_score": { "type": "integer", "default": 69 },
                  "characteristics": {
                    "type": "array",
                    "items": { "type": "string" },
                    "default": ["Multiple critical findings", "Fundamental control failures", "ATO not recommended"]
                  }
                }
              }
            }
          }
        }
      },
      "executive_summary": {
        "type": "object",
        "required": ["overall_compliance_score", "total_ksis", "compliance_level"],
        "properties": {
          "overall_compliance_score": {
            "type": "integer",
            "minimum": 0,
            "maximum": 100,
            "description": "Overall compliance percentage calculated using weighted KSI scores"
          },
          "score_breakdown": {
            "type": "object",
            "properties": {
              "weighted_ksi_contribution": {
                "type": "number",
                "description": "Contribution from weighted KSI scores"
              },
              "finding_deductions": {
                "type": "number",
                "description": "Total points deducted due to findings"
              },
              "calculation_details": {
                "type": "string",
                "description": "Detailed explanation of score calculation"
              }
            }
          },
          "total_ksis": {
            "type": "integer",
            "minimum": 1,
            "description": "Total number of Key Security Implementation areas"
          },
          "fully_implemented": {
            "type": "integer",
            "minimum": 0,
            "description": "Number of KSIs with scores >= 90% and no critical findings"
          },
          "partially_implemented": {
            "type": "integer", 
            "minimum": 0,
            "description": "Number of KSIs with scores 50-89% or with critical findings but remediation plans"
          },
          "failed": {
            "type": "integer",
            "minimum": 0,
            "description": "Number of KSIs with scores < 50% or fundamental control failures"
          },
          "not_applicable": {
            "type": "integer",
            "minimum": 0,
            "description": "Number of KSIs determined not applicable to system architecture"
          },
          "compliance_level": {
            "type": "string",
            "enum": ["FULLY_COMPLIANT", "SUBSTANTIALLY_COMPLIANT", "PARTIALLY_COMPLIANT", "NON_COMPLIANT"],
            "description": "Overall compliance status based on score thresholds and finding severity"
          },
          "critical_findings": {
            "type": "integer",
            "minimum": 0,
            "description": "Number of critical severity findings"
          },
          "high_findings": {
            "type": "integer",
            "minimum": 0,
            "description": "Number of high severity findings"
          },
          "medium_findings": {
            "type": "integer",
            "minimum": 0,
            "description": "Number of medium severity findings"
          },
          "low_findings": {
            "type": "integer",
            "minimum": 0,
            "description": "Number of low severity findings"
          }
        }
      },
      "fedramp_low_ksi_assessment": {
        "type": "object",
        "required": ["KSI-CNA", "KSI-SVC", "KSI-IAM", "KSI-MLA", "KSI-CMT", "KSI-PIY", "KSI-TPR", "KSI-CED", "KSI-RPL", "KSI-INR"],
        "properties": {
          "KSI-CNA": { "$ref": "#/$defs/ksi_assessment" },
          "KSI-SVC": { "$ref": "#/$defs/ksi_assessment" },
          "KSI-IAM": { "$ref": "#/$defs/ksi_assessment" },
          "KSI-MLA": { "$ref": "#/$defs/ksi_assessment" },
          "KSI-CMT": { "$ref": "#/$defs/ksi_assessment" },
          "KSI-PIY": { "$ref": "#/$defs/ksi_assessment" },
          "KSI-TPR": { "$ref": "#/$defs/ksi_assessment" },
          "KSI-CED": { "$ref": "#/$defs/ksi_assessment" },
          "KSI-RPL": { "$ref": "#/$defs/ksi_assessment" },
          "KSI-INR": { "$ref": "#/$defs/ksi_assessment" }
        }
      },
      "security_controls_matrix": {
        "type": "object",
        "properties": {
          "access_control": { "$ref": "#/$defs/control_family" },
          "audit_accountability": { "$ref": "#/$defs/control_family" },
          "configuration_management": { "$ref": "#/$defs/control_family" },
          "identification_authentication": { "$ref": "#/$defs/control_family" },
          "system_communications_protection": { "$ref": "#/$defs/control_family" },
          "system_information_integrity": { "$ref": "#/$defs/control_family" },
          "incident_response": { "$ref": "#/$defs/control_family" },
          "maintenance": { "$ref": "#/$defs/control_family" },
          "media_protection": { "$ref": "#/$defs/control_family" },
          "physical_environmental_protection": { "$ref": "#/$defs/control_family" },
          "planning": { "$ref": "#/$defs/control_family" },
          "personnel_security": { "$ref": "#/$defs/control_family" },
          "risk_assessment": { "$ref": "#/$defs/control_family" },
          "system_services_acquisition": { "$ref": "#/$defs/control_family" }
        }
      },
      "infrastructure_assessment": {
        "type": "object",
        "properties": {
          "network_security": { "$ref": "#/$defs/infrastructure_component" },
          "compute_security": { "$ref": "#/$defs/infrastructure_component" },
          "data_protection": { "$ref": "#/$defs/infrastructure_component" },
          "monitoring_logging": { "$ref": "#/$defs/infrastructure_component" },
          "identity_access": { "$ref": "#/$defs/infrastructure_component" },
          "backup_recovery": { "$ref": "#/$defs/infrastructure_component" }
        }
      },
      "compliance_gaps": {
        "type": "array",
        "items": { "$ref": "#/$defs/compliance_gap" }
      },
      "recommendations": {
        "type": "array",
        "items": { "$ref": "#/$defs/recommendation" }
      },
      "next_assessment": {
        "type": "object",
        "required": ["recommended_date", "frequency"],
        "properties": {
          "recommended_date": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp for next assessment"
          },
          "frequency": {
            "type": "string",
            "enum": ["Monthly", "Quarterly", "Semi-Annual", "Annual"],
            "description": "Recommended assessment frequency"
          },
          "focus_areas": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Areas requiring focused attention in next assessment"
          }
        }
      },
      "certification_readiness": {
        "type": "object",
        "required": ["fedramp_low_ready", "estimated_ato_timeline"],
        "properties": {
          "fedramp_low_ready": {
            "type": "boolean",
            "description": "Whether system is ready for FedRAMP Low ATO"
          },
          "estimated_ato_timeline": {
            "type": "string",
            "pattern": "^\\d+-\\d+ (days|weeks|months)$",
            "description": "Estimated timeline to achieve ATO"
          },
          "critical_blockers": {
            "type": "integer",
            "minimum": 0,
            "description": "Number of critical issues blocking certification"
          },
          "documentation_completeness": {
            "type": "integer",
            "minimum": 0,
            "maximum": 100,
            "description": "Percentage of required documentation completed"
          },
          "technical_implementation": {
            "type": "integer",
            "minimum": 0,
            "maximum": 100,
            "description": "Percentage of technical controls implemented"
          }
        }
      }
    },
    "$defs": {
      "ksi_assessment": {
        "type": "object",
        "required": ["name", "status", "score"],
        "properties": {
          "name": {
            "type": "string",
            "description": "Human-readable name of the KSI"
          },
          "status": {
            "type": "string",
            "enum": ["FULLY_IMPLEMENTED", "PARTIALLY_IMPLEMENTED", "NOT_IMPLEMENTED", "NOT_APPLICABLE"],
            "description": "Implementation status determined by score thresholds and finding analysis"
          },
          "score": {
            "type": "integer",
            "minimum": 0,
            "maximum": 100,
            "description": "Compliance score calculated from control implementation percentage minus finding deductions"
          },
          "score_calculation": {
            "type": "object",
            "properties": {
              "base_implementation_score": {
                "type": "integer",
                "minimum": 0,
                "maximum": 100,
                "description": "Base score from control implementation assessment"
              },
              "finding_deductions": {
                "type": "integer",
                "description": "Points deducted due to findings"
              },
              "final_score": {
                "type": "integer",
                "minimum": 0,
                "maximum": 100,
                "description": "Final score after applying deductions"
              },
              "status_rationale": {
                "type": "string",
                "description": "Explanation of how status was determined from score and findings"
              }
            }
          },
          "evidence": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "List of evidence supporting the assessment"
          },
          "findings": {
            "type": "array",
            "items": { "$ref": "#/$defs/finding" },
            "description": "List of findings for this KSI"
          }
        }
      },
      "finding": {
        "type": "object",
        "required": ["severity", "finding", "recommendation"],
        "properties": {
          "severity": {
            "type": "string",
            "enum": ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFORMATIONAL"],
            "description": "Severity level affecting score calculation and status determination"
          },
          "finding": {
            "type": "string",
            "description": "Description of the finding"
          },
          "recommendation": {
            "type": "string",
            "description": "Recommended remediation action"
          },
          "control_reference": {
            "type": "string",
            "description": "NIST 800-53 control reference(s)"
          },
          "score_impact": {
            "type": "integer",
            "description": "Points deducted from KSI score due to this finding"
          }
        }
      },
      "control_family": {
        "type": "object",
        "patternProperties": {
          "^[a-z]{2}_\\d+$": {
            "type": "string",
            "pattern": "^(IMPLEMENTED|PARTIALLY_IMPLEMENTED|NOT_IMPLEMENTED|NOT_APPLICABLE) - .+$",
            "description": "Control implementation status with description"
          }
        }
      },
      "infrastructure_component": {
        "type": "object",
        "required": ["status"],
        "properties": {
          "status": {
            "type": "string",
            "enum": ["COMPLIANT", "PARTIALLY_COMPLIANT", "NON_COMPLIANT", "NOT_ASSESSED"],
            "description": "Compliance status of the infrastructure component"
          },
          "components": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "List of specific components assessed"
          },
          "findings": {
            "type": "array",
            "items": { "$ref": "#/$defs/finding" },
            "description": "Findings specific to this infrastructure component"
          }
        }
      },
      "compliance_gap": {
        "type": "object",
        "required": ["gap_id", "severity", "category", "description", "remediation"],
        "properties": {
          "gap_id": {
            "type": "string",
            "pattern": "^GAP-\\d{3}$",
            "description": "Unique identifier for the compliance gap"
          },
          "severity": {
            "type": "string",
            "enum": ["CRITICAL", "HIGH", "MEDIUM", "LOW"],
            "description": "Severity level of the gap"
          },
          "category": {
            "type": "string",
            "description": "Category of the compliance gap"
          },
          "description": {
            "type": "string",
            "description": "Detailed description of the gap"
          },
          "affected_controls": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^[A-Z]{2}-\\d+$"
            },
            "description": "NIST 800-53 controls affected by this gap"
          },
          "remediation": {
            "type": "string",
            "description": "Recommended remediation steps"
          },
          "timeline": {
            "type": "string",
            "description": "Recommended timeline for remediation"
          }
        }
      },
      "recommendation": {
        "type": "object",
        "required": ["priority", "category", "recommendation"],
        "properties": {
          "priority": {
            "type": "string",
            "enum": ["CRITICAL", "HIGH", "MEDIUM", "LOW"],
            "description": "Priority level of the recommendation"
          },
          "category": {
            "type": "string",
            "description": "Category of the recommendation"
          },
          "recommendation": {
            "type": "string",
            "description": "Detailed recommendation text"
          },
          "business_impact": {
            "type": "string",
            "description": "Expected business impact of implementing the recommendation"
          }
        }
      }
    }
  })
}
